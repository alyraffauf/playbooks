---
# WiFi role - Configure NetworkManager WiFi connections

- name: Create WPA2-PSK WiFi connection files
  ansible.builtin.template:
    src: wpa2.nmconnection.j2
    dest: "/etc/NetworkManager/system-connections/{{ item.ssid }}.nmconnection"
    mode: "0600"
    owner: root
    group: root
  loop: "{{ networks | selectattr('type', 'equalto', 'wpa2') | list }}"
  become: true
  no_log: true
  register: wpa2_result

- name: Create open WiFi connection files
  ansible.builtin.template:
    src: open.nmconnection.j2
    dest: "/etc/NetworkManager/system-connections/{{ item.ssid }}.nmconnection"
    mode: "0600"
    owner: root
    group: root
  loop: "{{ networks | selectattr('type', 'equalto', 'open') | list }}"
  become: true
  register: open_result

- name: Create EAP WiFi connection files
  ansible.builtin.template:
    src: eap.nmconnection.j2
    dest: "/etc/NetworkManager/system-connections/{{ item.ssid }}.nmconnection"
    mode: "0600"
    owner: root
    group: root
  loop: "{{ networks | selectattr('type', 'equalto', 'eap') | list }}"
  become: true
  no_log: true
  register: eap_result

- name: Reload NetworkManager
  ansible.builtin.command:
    cmd: nmcli connection reload
  when: wpa2_result.changed or open_result.changed or eap_result.changed
  changed_when: true
  become: true

- name: Wait for internet connection
  ansible.builtin.wait_for:
    host: 1.1.1.1
    port: 443
    timeout: 30
  when: wpa2_result.changed or open_result.changed or eap_result.changed
